<!DOCTYPE html>

<html dir="ltr"
      lang="en"
      style="height: 100%; width: 100%;">

<head>
  <link crossorigin=""
        href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css"
        rel="stylesheet">
  <meta charset="utf-8">
  <script crossorigin=""
          integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
          src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
</head>

<body style="height: 100%; margin: 0; width: 100%;">
  <div id="map" style="height: 100%; width: 100%;"></div>
  <form style="align-items: center;
              background-clip: padding-box;
              background-color: white;
              border: 2px solid rgba(0, 0, 0, .2);
              border-radius: 5px;
              display: flex;
              left: 52px;
              padding: 10px;
              position: absolute;
              top: 10px;
              z-index: 999;">
    <span>Filtrer par&nbsp;</span>
    <input checked id="region" name="filter" onclick="load(REGION_MARKERS);" type="radio">
    <label for="region">&nbsp;région&nbsp;</label>
    <input id="address" name="filter" onclick="load(ADDRESS_MARKERS);" type="radio">
    <label for="address">&nbsp;adresse</label>
  </form>

  <script>
    const MAP = L.map('map').setView([46.227638, 2.213749], 5);
  
    const TILES = L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; <a href="https://immocitiz.fr/" target="_top">Immocitiz</a>',
      maxZoom: 99
    }).addTo(MAP);

    const REGION_MARKERS = L.layerGroup();
    const ADDRESS_MARKERS = L.layerGroup();
  
    fetch('https://hook.eu1.make.com/2fch5v4swraen6yc9wuzc7g8inp9few6')
      .then(response => response.json())
      .then(response => {
        let regionCount = {};
        response.forEach(product => {
          if (regionCount[product.produit.region] === undefined) {
            regionCount[product.produit.region] = 0;
          }
          regionCount[product.produit.region] += 1;
          markAddress(product);
        });
        Object.entries(regionCount).forEach(region => {
          markRegion(region[0], region[1])
        });
        load(REGION_MARKERS);
      });

    const markRegion = (name, description) => {
      fetch('https://hook.eu1.make.com/tngrla4gctib9pa4uq4m5j2n0njbb1yu?address=' + encodeURI(name))
        .then(response => response.json())
        .then(response => {
          let collection = '<a href="https://immocitiz.store/collections/';
          switch (name) {
            case 'Auvergne-Rhône-Alpes':
            case 'Bourgogne-Franche-Comté':
            case 'Grand Est':
              collection += 'grand-est';
              break;
            case 'Bretagne':
            case 'Centre-Val de Loire':
            case 'Normandie':
            case 'Nouvelle-Aquitaine':
            case 'Pays de la Loire':
              collection += 'grand-ouest';
              break;
            case 'Hauts-de-France':
              collection += 'hauts-de-france';
              break;
            case 'Occitanie':
            case 'Provence-Alpes-Côte d\'Azur':
              collection += 'sud';
              break;
            case 'Île-de-France':
              collection += 'ile-de-france';
              break;
            default:
              collection += 'all';
              break;
          }
          collection += '" target="_top">En savoir plus</a>';
          L.marker([response.results[0].geometry.location.lat, response.results[0].geometry.location.lng], {
              title: name
          }).addTo(REGION_MARKERS)
            .bindPopup(
              '<b>' + name + '</b><br>' +
              description + ' opportunité(s)<br>' +
              collection
            );
        });
    }

    const markAddress = product => {
      fetch('https://hook.eu1.make.com/tngrla4gctib9pa4uq4m5j2n0njbb1yu?address=' + encodeURI(product.produit.address))
        .then(response => response.json())
        .then(response => {
          L.marker([response.results[0].geometry.location.lat, response.results[0].geometry.location.lng], {
              title: product.produit.address
          }).addTo(ADDRESS_MARKERS)
            .bindPopup(
              '<b>' + product.produit.address + '</b><br><br>' +
              '<span>Investissement total : <b>' + product.produit.totalInvestment + ' €</b></span><br>' +
              '<span>Rentabilité brute : <b>' + product.produit.profitability + ' %</b></span><br><br>' +
              '<div id="carouselExampleIndicators" class="carousel slide">' +
                '<div class="carousel-indicators">' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="0" class="active" aria-current="true" aria-label="Slide 1"></button>' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="1" aria-label="Slide 2"></button>' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="2" aria-label="Slide 3"></button>' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="3" aria-label="Slide 4"></button>' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="4" aria-label="Slide 5"></button>' +
                  '<button type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide-to="5" aria-label="Slide 6"></button>' +
                '</div>' +
                '<div class="carousel-inner">' +
                  '<div class="carousel-item active">' +
                    '<img src="' + product.produit.visual1 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                  '<div class="carousel-item">' +
                    '<img src="' + product.produit.visual2 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                  '<div class="carousel-item">' +
                    '<img src="' + product.produit.visual3 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                  '<div class="carousel-item">' +
                    '<img src="' + product.produit.visual4 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                  '<div class="carousel-item">' +
                    '<img src="' + product.produit.visual5 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                  '<div class="carousel-item">' +
                    '<img src="' + product.produit.visual6 + '?profile=visuel1" class="d-block w-100" alt="..." style="border: 2px solid rgba(0, 0, 0, .2); border-radius: 16px;">' +
                  '</div>' +
                '</div>' +
                '<button class="carousel-control-prev" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="prev">' +
                  '<span class="carousel-control-prev-icon" aria-hidden="true"></span>' +
                  '<span class="visually-hidden">Previous</span>' +
                '</button>' +
                '<button class="carousel-control-next" type="button" data-bs-target="#carouselExampleIndicators" data-bs-slide="next">' +
                  '<span class="carousel-control-next-icon" aria-hidden="true"></span>' +
                  '<span class="visually-hidden">Next</span>' +
                '</button>' +
              '</div><br>' +
              '<a href="#">En savoir plus</a>'
            );
        });
    }

    const load = markers => {
      MAP.removeLayer(REGION_MARKERS);
      MAP.removeLayer(ADDRESS_MARKERS);
      MAP.addLayer(markers);
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>

</body>

</html>
